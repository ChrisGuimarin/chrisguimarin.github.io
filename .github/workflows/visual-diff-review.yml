name: Visual Diff Review

on:
  pull_request:
    branches: [main]

jobs:
  visual-diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run visual regression tests
        id: visual-tests
        continue-on-error: true
        run: npm run test:visual

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload visual diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff-images
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testStatus = '${{ steps.visual-tests.outcome }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let comment = '## Visual Regression Test Results\n\n';

            if (testStatus === 'success') {
              comment += '✅ **All visual tests passed!**\n\n';
              comment += 'No visual changes detected.';
            } else {
              comment += '⚠️ **Visual changes detected!**\n\n';
              comment += '### Review Required\n\n';
              comment += 'Visual regression tests found differences. Please review:\n\n';
              comment += `1. [Download test artifacts](${runUrl}) to review visual diffs\n`;
              comment += '2. If changes are intentional, update baselines using the "Update Visual Baselines" workflow\n';
              comment += '3. If changes are unintentional, fix the visual issues\n\n';
              comment += '### Next Steps\n\n';
              comment += '- **Approve changes**: Run "Update Visual Baselines" workflow on this branch\n';
              comment += '- **Reject changes**: Fix visual issues and push new commits\n\n';
              comment += `[View full test report](${runUrl})`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Set status check
        if: failure()
        run: |
          echo "Visual changes detected - manual review required"
          exit 1
